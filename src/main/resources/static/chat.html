<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f6f6f6;
            display: flex;
            justify-content: center;
            padding: 30px;
        }

        .chat-box {
            width: 100%;
            max-width: 480px;
            height: 90vh;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        h1 {
            margin: 0;
            padding: 16px;
            font-size: 20px;
            color: #333;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .room-info {
            padding: 8px 16px;
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
            font-size: 12px;
            color: #666;
        }

        #messages {
            list-style: none;
            padding: 16px;
            margin: 0;
            flex: 1;
            overflow-y: auto;
            background-color: #fafafa;
        }

        #messages li {
            margin: 10px 0;
            padding: 10px 14px;
            border-radius: 14px;
            max-width: 70%;
            clear: both;
        }

        .me {
            background-color: #ff8a3d;
            float: right;
            text-align: right;
            color: white;
        }

        .server {
            background-color: #eeeeee;
            float: left;
            color: black;
        }

        .input-area {
            padding: 16px;
            border-top: 1px solid #eee;
            background-color: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        .input-row input[type="text"],
        .input-row input[type="file"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        .input-area button {
            padding: 10px 16px;
            background-color: #ff8a3d;
            color: white;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .input-area button:hover {
            background-color: #e97827;
        }

        .error {
            color: #ff4444;
            background-color: #ffeeee;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div class="chat-box">
    <h1>ì±„íŒ…ë°©</h1>
    <div class="room-info">
        ì±„íŒ…ë°© ID: <span id="roomIdDisplay">ë¡œë”© ì¤‘...</span>
    </div>
    <ul id="messages"></ul>

    <div class="input-area">
        <div id="errorMessage" class="error" style="display: none;"></div>

        <input type="text" id="tokenInput" placeholder="JWT í† í°ì„ ì…ë ¥í•˜ì„¸ìš”" />
        <button onclick="connectStomp()">ì—°ê²°</button>

        <div class="input-row">
            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
            <button onclick="sendTextMessage()">í…ìŠ¤íŠ¸ ë³´ë‚´ê¸°</button>
        </div>

        <div class="input-row">
            <input type="file" id="imageInput" accept="image/*" />
            <button onclick="sendImageMessage()">ì´ë¯¸ì§€ ë³´ë‚´ê¸°</button>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let token = null;
    let myUserId = null;
    let chatRoomId = null;

    // URLì—ì„œ ì±„íŒ…ë°© ID ê°€ì ¸ì˜¤ê¸°
    function getChatRoomIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');

        if (roomId) {
            return roomId;
        }

        // URL ê²½ë¡œì—ì„œ ê°€ì ¸ì˜¤ê¸° (ì˜ˆ: /chat/room/68527de5590ad16d49306e45)
        const pathParts = window.location.pathname.split('/');
        const roomIndex = pathParts.indexOf('room');
        if (roomIndex !== -1 && roomIndex + 1 < pathParts.length) {
            return pathParts[roomIndex + 1];
        }

        return null;
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    function hideError() {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.style.display = 'none';
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì±„íŒ…ë°© ID ì„¤ì •
    window.onload = function() {
        chatRoomId = getChatRoomIdFromUrl();

        if (!chatRoomId) {
            showError('ì±„íŒ…ë°© IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. URLì— ?roomId=ì±„íŒ…ë°©ID ë˜ëŠ” /room/ì±„íŒ…ë°©IDë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.');
            document.getElementById('roomIdDisplay').textContent = 'ì—†ìŒ';
            return;
        }

        document.getElementById('roomIdDisplay').textContent = chatRoomId;
        hideError();
    };

    function connectStomp() {
        if (!chatRoomId) {
            showError('ì±„íŒ…ë°© IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }

        token = document.getElementById("tokenInput").value.trim();
        if (!token) {
            showError("í† í°ì„ ì…ë ¥í•˜ì„¸ìš”!");
            return;
        }

        try {
            const parsedToken = JSON.parse(atob(token.split('.')[1]));
            myUserId = parseInt(parsedToken.sub, 10);
        } catch (e) {
            showError("ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.");
            return;
        }

        // const socket = new SockJS("http://localhost:8080/ws-chat");
        const socket = new SockJS("https://petory.click/ws-chat");
        stompClient = Stomp.over(socket);

        stompClient.connect(
            {
                Authorization: `Bearer ${token}`
            },
            (frame) => {
                console.log("ğŸŸ¢ STOMP ì—°ê²°ë¨:", frame);
                hideError();

                stompClient.subscribe(`/sub/room/${chatRoomId}`, (message) => {
                    const data = JSON.parse(message.body);
                    const isMine = data.senderId === myUserId;
                    const className = isMine ? "me" : "server";
                    const sender = isMine ? "ë‚˜" : data.senderNickname || "ìƒëŒ€ë°©";

                    if (data.messageType === "IMAGE") {
                        addImage(sender, data.content, className);
                    } else {
                        addMessage(sender, data.content, className);
                    }
                });
            },
            (error) => {
                console.error("ğŸ”´ STOMP ì—°ê²° ì‹¤íŒ¨:", error);
                showError("STOMP ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        );
    }

    function sendTextMessage() {
        if (!stompClient || !chatRoomId) {
            showError("ë¨¼ì € ì±„íŒ…ë°©ì— ì—°ê²°í•˜ì„¸ìš”!");
            return;
        }

        const text = document.getElementById("messageInput").value.trim();
        if (!text) {
            showError("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
            return;
        }

        stompClient.send("/pub/message", {
            Authorization: `Bearer ${token}`
        }, JSON.stringify({
            chatRoomId,
            messageType: "TEXT",
            content: text
        }));

        document.getElementById("messageInput").value = "";
        hideError();
    }

    async function sendImageMessage() {
        if (!stompClient || !chatRoomId) {
            showError("ë¨¼ì € ì±„íŒ…ë°©ì— ì—°ê²°í•˜ì„¸ìš”!");
            return;
        }

        const imageFile = document.getElementById("imageInput").files[0];
        if (!imageFile) {
            showError("ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”!");
            return;
        }

        try {
            const presignRes = await fetch("/chat/image", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({
                    chatRoomId,
                    filename: imageFile.name,
                    contentType: imageFile.type
                })
            });

            if (!presignRes.ok) {
                showError("Presigned URL ë°œê¸‰ ì‹¤íŒ¨");
                return;
            }

            const resJson = await presignRes.json();
            const { uploadUrl, fileUrl } = resJson.data;

            const uploadRes = await fetch(uploadUrl, {
                method: "PUT",
                headers: {
                    "Content-Type": imageFile.type
                },
                body: imageFile
            });

            if (!uploadRes.ok) {
                showError("S3 ì—…ë¡œë“œ ì‹¤íŒ¨");
                return;
            }

            stompClient.send("/pub/message", {
                Authorization: `Bearer ${token}`
            }, JSON.stringify({
                chatRoomId,
                messageType: "IMAGE",
                content: fileUrl
            }));

            document.getElementById("imageInput").value = "";
            hideError();
        } catch (error) {
            showError("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            console.error(error);
        }
    }

    function addMessage(sender, text, className) {
        const list = document.getElementById("messages");
        const item = document.createElement("li");
        item.className = className;
        item.textContent = `${sender}: ${text}`;
        list.appendChild(item);
        list.scrollTop = list.scrollHeight;
    }

    function addImage(sender, imageUrl, className) {
        const list = document.getElementById("messages");
        const item = document.createElement("li");
        item.className = className;
        item.innerHTML = `${sender}: <br/><img src="${imageUrl}" style="max-width: 200px; border-radius: 8px;" />`;
        list.appendChild(item);
        list.scrollTop = list.scrollHeight;
    }
</script>
</body>
</html>